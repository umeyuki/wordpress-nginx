upstream umeyuki_blog {
    ip_hash;
    server unix:/var/run/umeyuki_blog.sock;
}

server {
   server_name www.umeyuki.net;
   rewrite ^ http://umeyuki.net$request_uri? permanent;
}

server {
    listen 80;
    server_name umeyuki.net;
    root /var/www/umeyuki.net;

    access_log /var/log/nginx/umeyuki_blog_access.log main;
    error_log /var/log/nginx/umeyuki_blog_error.log;
    port_in_redirect off;

    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    location = /robots.txt {
        access_log off;
        log_not_found off;
    }
    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }
    location /wp-admin {
        proxy_pass http://umeyuki_blog;
    }
    location ~ .*.php {
        proxy_pass http://umeyuki_blog;
    }
    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
        log_not_found off;
        proxy_pass http://umeyuki_blog;
    }
    location ~ /purge(/.*) {
       allow 127.0.0.1;
       allow 192.0.2.1;
       deny all;       
       proxy_cache_purge czone "$scheme://$host$1$is_args$args$mobile";
    }

    location / {
        if ($http_user_agent ~* '(DoCoMo|J-PHONE|Vodafone|MOT-|UP\.Browser|DDIPOCKET|ASTEL|PDXGW|Palmscape|Xiino|sharp pda browser|Windows CE|L-mode|WILLCOM|SoftBank|Semulator|Vemulator|J-EMULATOR|emobile|mixi-mobile-converter)') {
           set $mobile 1;
        }
        if ($http_user_agent ~* '(iPhone|iPod|Opera Mini|Android.*Mobile|NetFront|PSP|BlackBerry)') {
            set $mobile 2;
        }
        if ($http_cookie ~* "comment_author_[^=]*=([^%]+)%7C|wordpress_logged_in_[^=]*=([^%]+)%7C") {
            set $do_not_cache 1;
        }
        if ($http_user_agent ~* “2.0\ 2MMP|240×320|400X240|AvantGo|BlackBerry|Blazer|Cellphone|Danger|DoCoMo|Elaine/3.0|EudoraWeb|Googlebot-Mobile|hiptop|IEMobile|KYOCERA/WX310K|LG/U990|MIDP-2.|MMEF20|MOT-V|NetFront|Newt|Nintendo\ Wii|Nitro|Nokia|Opera\ Mini|Palm|PlayStation\ Portable|portalmmm|Proxinet|ProxiNet|SHARP-TQ-GX10|SHG-i900|Small|SonyEricsson|Symbian\ OS|SymbianOS|TS21i-10|UP.Browser|UP.Link|webOS|Windows\ CE|WinWAP|YahooSeeker/M1A1-R2D2|iPhone|iPod|Android|BlackBerry9530|LG-TU915\ Obigo|LGE\ VX|webOS|Nokia5800″) {
          set $do_not_cache 1;
        } 
        proxy_no_cache     $do_not_cache;
        proxy_cache_bypass $do_not_cache;
        proxy_cache czone;
        proxy_cache_key "$scheme://$host$request_uri$is_args$args$mobile";
        proxy_cache_valid  200 301 302 30m;
        proxy_cache_valid  404 5m;
        proxy_cache_use_stale  error timeout invalid_header updating
                               http_500 http_502 http_503 http_504;
        proxy_pass http://umeyuki_blog;
    }
}

server {
    listen unix:/var/run/umeyuki_blog.sock;
    server_name umeyuki.net;
    root /var/www/umeyuki.net;
 
    access_log /var/log/nginx/umeyuki_blog_access.log main;
    error_log /var/log/nginx/umeyuki_blog_error.log;
    port_in_redirect off;
 
    location / {
        index index.php;
 
        if (-f $request_filename) {
            expires 14d;
            break;
        }
    }
    if (!-e $request_filename) {
                rewrite ^.+?($/-.*) $1 last;
                rewrite ^.+?(/.*\.php)$ $1 last;
                rewrite ^ /index.php last;
    }
    location ~ \.php$ {
        fastcgi_pass   unix:/var/run/php-fpm/php-fpm.sock;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include        fastcgi_params;
    }
}
