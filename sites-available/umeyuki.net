# Virtual Configuration for PHP FastCGI
server {
    listen   18081; ## listen for ipv4; this line is default and implied
    #listen   [::]:80 default ipv6only=on; ## listen for ipv6

    server_name  _;
    root   /var/www/umeyuki.net;
    location / {
        index  index.php;

        # static files
        if (-f $request_filename) {
            expires 30d;
            break;
        }

        # request to index.php
        if (!-e $request_filename) {
            rewrite ^(.+)$  /index.php?q=$1 last;
        }
    }

    location ~ \.php$ {
        include        fastcgi_params;
        fastcgi_pass   phpfpm;
        fastcgi_param  SCRIPT_FILENAME  /var/www/umeyuki.net/$fastcgi_script_name;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_index  index.php;
        fastcgi_pass_header "X-Accel-Redirect";
        fastcgi_pass_header "X-Accel-Expires";
    }

    access_log /var/log/nginx/umeyuki.net/fcgi_access.log;
    error_log /var/log/nginx/umeyuki.net/fcgi_error.log;
}

server {
    listen 80;
    server_name umeyuki.net *.umeyuki.net;

    location ~ /favicon.ico {
        access_log  off;
        expires 24h;
        root /var/www/umeyuki.net;
        break;
    }
    location ~ ^/(media|share_img)/.+.(jpg|jpeg|gif|png|css|js|flv|swf|ico|xml)(\?[0-9\.]*)?$ {
        access_log  off;
        expires 24h;
        root /var/www/umeyuki.net;
        break;
    }
    location ~ ^/purge(/.*)$ {
        access_log  off;
        allow 127.0.0.1;
        allow 49.212.131.72;
        deny all;
        proxy_cache_purge czone "$scheme$host$1";
    }

    # WordPress Static Files
    location ~ ^/wp-[^/]+/.+.(jpg|jpeg|gif|png|css|js|flv|swf|ico|xml)(\?[0-9\.]*)?$ {
        access_log  off;
        #expires 24h;
        root /var/www/umeyuki.net;
        break;
    }
    rewrite /wp-admin$ $scheme://$host$uri/ permanent;
    proxy_set_header  Host               $host;
    proxy_set_header  X-Real-IP          $remote_addr;
    proxy_set_header  Remote-Addr        $remote_addr;
    proxy_set_header  X-Forwarded-Host   $host;
    proxy_set_header  X-Forwarded-Server $host;
    proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_connect_timeout 30;
    proxy_send_timeout 30;
    proxy_read_timeout 60;
    access_log /var/log/nginx/umeyuki.net/access.log;
    error_log /var/log/nginx/umeyuki.net/error.log;
    if (!-e $request_filename) {
#        rewrite ^/(.+)$ /$1 redirect;
        rewrite ^/(wp-.*)$ /$1 last;
#        rewrite ^/(wp-admin/.*\.php)$ /$1 last;
        rewrite ^/(.*\.php)$ /$1 last;
    }
    location / {
        set $do_not_cache 0;
        if ($http_cookie ~* "comment_author_|wordpress_(?!test_cookie)|wp-postpass_" ) {
            set $do_not_cache 1;
        }

        if ( $uri ~ /wp-content/(plugins|themes)/.+\.(jpg|jpeg|gif|png|css|js|flv|swf|ico|xml)(\?ver=.+)?$ ) {
            access_log off;
            expires 24h;
        } 

        if ( $uri ~ /wp-includes/(js|css|images)/.+\.(jpg|jpeg|gif|png|css|js|flv|swf|ico|xml)(\?ver=.+)?$ ) {
            access_log off;
            expires 24h;
        } 

        if ($http_user_agent ~* “2.0\ 2mmp|240×320|400x240|avantgo|blackberry|blazer|cellphone|danger|docomo|elaine/3.0|eudoraweb|googlebot-mobile|hiptop|iemobile|kyocera/wx310k|lg/u990|midp-2.|mmef20|mot-v|netfront|newt|nintendo\ wii|nitro|nokia|opera\ mini|palm|playstation\ portable|portalmmm|proxinet|proxinet|sharp-tq-gx10|shg-i900|small|sonyericsson|symbian\ os|symbianos|ts21i-10|up.browser|up.link|webos|windows\ ce|winwap|yahooseeker/m1a1-r2d2|iphone|ipod|android|blackberry9530|lg-tu915\ obigo|lge\ vx|webos|nokia5800″) {
            set $do_not_cache 1;
        }

        proxy_no_cache     $do_not_cache;
        proxy_cache_bypass $do_not_cache;
        proxy_cache        czone;
        proxy_cache_key    "$scheme$host$request_uri";
        proxy_cache_valid  200 1d;
        proxy_pass         http://umeyuki.net_backend;

    }
}
